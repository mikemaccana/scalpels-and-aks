<!DOCTYPE html><html><head><title>ðŸ”ª and ðŸ”«</title><meta charset="utf-8"><script src="slides.js"></script><link href="css/styles.css" rel="stylesheet" type="text/css"></head><body><section class="slides layout-regular template-default"><article><p>Yaay the projector works</p><small>You may need to zoom out a little if the text is too big</small></article><article class="first"><h1 style="text-transform: uppercase">Scalpels and AKs</h1><h2>Scrape anything with node.js</h2><br><h3><a href="http://twitter.com/mikemaccana" style="text-decoration: none;">@mikemaccana</a></h3></article><article class="plain"><h1>THIS <br>WILL<br> WORK.</h1></article><article><img src="images/ev-ssl.png"><h2><br/>CertSimple does EV</h2><p>Confirms legal entity behind a site</p><p>Normally a pain in the arse to get.</p></article><article class="plain"><h1 style="font-size: 192pt; line-height: 158pt;">CertSimple do EV 40-100x faster than Symantec, GoDaddy, and Comodo.</h1></article><article><h2>We connect to:</h2><ul class="build"><li>Government data for 100M companies in 63 countries</li><li>60+ independent data sources</li><li>Other data sources: DNS, whois, and a CA.</li></ul></article><article><h1>Problem</h1><ul class="build"><li>Some data sources don't have APIs at all</li><li>API exists, but missing some functionality exposed through UI</li><li>No webhooks, so no realtime</li></ul></article><article><p>How to scrape anything you want</p><p>All the things you'll wish you knew earlier</p></article><article><h1>THE SCALPEL</h1><p>Use this 95% of the time</p></article><article><h1>LOG IN and SCRAPE</h1></article><article><h2>How to log in - cookies!</h2><div class="comparison"><div class="option"><p>Using plain request:</p><pre class="prettyprint"><code data-lang="javascript">var request = require('request').defaults({jar: true})</code></pre></div><div class="option"><p>Using superagent:</p><pre class="prettyprint"><code data-lang="javascript">var superagent = require('superagent').agent();</code></pre></div></div></article><article><h1>Why Cheerio?</h1><ul class="build"><li>Way smaller and less complex than JSDOM</li><li>Pure JS, no compilation needed.</li><li>Familiar</li></ul></article><article><h2>Basic login with cheerio</h2><pre class="prettyprint"><code data-lang="javascript">agent
.get(loginUrl)
.end(function(err, res){

	var $ = cheerio.load(res.text);

	var loginDetails = {}

	// Collect the whole form - typically includes a CSRF token
	$('form input').each(function(index, element){
		loginDetails[element.attribs.name] = element.attribs.value
	});
	loginDetails.username = username
	loginDetails.password = password

	agent
	.post(loginUrl)
	// Superagent uses JSON by default
	.type('form')
	.set('Referer', 'https://www.somesite.com/account/login.php')
	.send(loginDetails)
	.end(function(err, res){
		...
	})
})
</code></pre></article><article><h1>Complete node scalpel approach</h1></article><article><h2>Scraping module</h2><pre class="prettyprint"><code data-lang="javascript">var superagent = require('superagent').agent();

var getLoggedInAgent = function(){
	...see previous example...
	cb(null, loggedInAgent)
}

module.exports = function(username, password, cb){

	getLoggedInAgent(username, password, function(err, loggedInAgent){

		var getCoolThing = function(){
			loggedInAgent...
		}

		var getOtherCoolThing = function(){
			loggedInAgent...
		}

		cb(null, {
			...
			getCoolThing,
			getOtherCoolThing
		})
	})
}
</code></pre></article><article><h2>The scalpel doesn't work on:</h2><ul class="build"><li>pages generated by JS</li><li>Single page apps without a 'fastboot' option</li><li>This monstrosity: http://directwebremoting.org/dwr/index.html</li></ul></article><article><h1>THE AK47</h1><p>Use this 5% of the time</p></article><article><q>When you absolutely, positively, got to get every datum in the site</q></article><article><h1>Why Casper?</h1><ul class="build"><li>Casper is higher level than PhantomJS</li><li>PhantomJS folks like Casper</li><li>SpookyJS (node) isn't maintained</li><li>You can evaluate JS in node + JSDOM, (and sandbox with require('vm').runInNewContext() ) but still...</li><li>Best place to simulate a browser is a headless browser</li></ul></article><article><h1>CASPER ISN'T NODE</h1></article><article><h2>Casper is it's own runtime</h2><ul class="build"><li>#!/usr/bin/env python starts python</li><li>#!/usr/bin/env ruby starts ruby</li><li>#!/usr/bin/env node starts node (v8)</li><li>#!/usr/bin/env casperjs starts casper (JavaScriptCore)</li></ul></article><article><h2>Casper code drives a browser</h2><p>Except stuff inside .evaluate(), which is run on the page</p><pre class="prettyprint"><code data-lang="javascript">var searchCompany = 'Foo Inc.'

casper.start('https://somesite.com/login');
casper.userAgent("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36");
casper.then(function(){
	this.fill('form[name=LoginForm]', {
		'username': config.username,
		'password': config.password
	}, true);
});

casper.waitForSelector('div.screenname', function() {
	screenName = this.evaluate(function(){
		return document.querySelector('div.screenname').innerText
	})
	log('screenname', screenName)
});

casper.then(function() {
	this.evaluate(function(searchCompany){
		document.querySelector('input.homepage-section-search-input-box').value = searchCompany;
	}, searchCompany)
});

casper.then(function() {
	this.mouseEvent('click', '#homepageSearchIcon')
});

casper.waitForSelector('#findCompaniesTab', function() {
// Switch to the companies tab
	this.mouseEvent('click', '#findCompaniesTab');
});
</code></pre></article><article><h2>CASPER SUPPORTS COMMONJS</h2><p>JavaScript modules only</p></article><article><h2>TALK TO CASPER AS A MICROSERVICE</h2><p>Using the 'webserver' commonjs module</p></article><article><p>Using the 'webserver' CommonJS module:</p><pre class="prettyprint"><code data-lang="javascript">#!/usr/bin/env casperjs
var casper = require('casper').create();
var server = require('webserver').create();
var ipAndPort = '127.0.0.1:8585';

server.listen(ipAndPort, function(request, response) {

    casper.start('https://connect.data.com/login');
    casper.userAgent("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36");
    casper.then(function(){
        // lots of code here, and a few more cassper.then()s
    });

    casper.run(function(){
        console.log('\n\nFinished')
        response.statusCode = 200;
        var body = JSON.stringify({
            phoneNumber: '1800-YOLO-SWAG'
        })

        response.write(body);
        response.close();
    });
});$


</code></pre></article><article><h2>Someone doesn't want me to scrape!</h2><ul class="build"><li>Reconsider</li><li>Use a modern useragent</li><li>Check your referers</li><li>proxymesh.com - 280s IPs per day</li><li>Various things on GitHub can defeat CloudFlare</li></ul></article><article><h1>Launching something?</h1></article><article><h1>Â£80 quid off CertSimple</h1></article><article><h1>Stickers!</h1><img src="images/certsimple-stickers.png"></article><article><h1 class="big">Thanks!</h1><h2>@mikemaccana</h2><h2>certsimple.com</h2></article><article><h1>Links</h1><a href="https://www.npmjs.com/package/request">Request cookies examples</a><a href="https://github.com/visionmedia/superagent/blob/master/test/node/agency.js">Superagent cookie examples</a><a href="https://github.com/cheeriojs/cheerio">Cheerio</a></article></section></body></html>